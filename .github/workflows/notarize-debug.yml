name: Notarize Debug

on:
  workflow_dispatch:

jobs:
  notarize:
    runs-on: macos-latest
    environment:
      name: release
      url: https://release.example.com
	steps:
 	  - name: Check secrets present
		run: |
			for v in MAC_CERT_P12_BASE64 MAC_CERT_PASS MAC_KEYCHAIN_PASS MAC_CODESIGN_ID; do
			if [[ -n "${!v}" ]]; then echo "$v is set"; else echo "$v is missing"; fi
			done
		env:
			MAC_CERT_P12_BASE64: ${{ secrets.MAC_CERT_P12_BASE64 }}
			MAC_CERT_PASS: ${{ secrets.MAC_CERT_PASS }}
			MAC_KEYCHAIN_PASS: ${{ secrets.MAC_KEYCHAIN_PASS }}
			MAC_CODESIGN_ID: ${{ secrets.MAC_CODESIGN_ID }}
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Configure
        shell: bash
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OUTPUT_TOOL_TESTS=OFF

      - name: Build
        shell: bash
        run: cmake --build build --config Release

      - name: Codesign (macOS)
        env:
          MAC_CERT_P12_BASE64: ${{ secrets.MAC_CERT_P12_BASE64 }}
          MAC_CERT_PASS: ${{ secrets.MAC_CERT_PASS }}
          MAC_KEYCHAIN_PASS: ${{ secrets.MAC_KEYCHAIN_PASS }}
          MAC_CODESIGN_ID: ${{ secrets.MAC_CODESIGN_ID }} # e.g., "Developer ID Application: Your Name (TEAMID)"
        shell: bash
        run: |
          if [[ -z "$MAC_CERT_P12_BASE64" ]]; then
            echo "No signing cert provided; skipping signing."
            exit 0
          fi
          echo "$MAC_CERT_P12_BASE64" | base64 --decode > cert.p12
          security create-keychain -p "$MAC_KEYCHAIN_PASS" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MAC_KEYCHAIN_PASS" build.keychain
          security import cert.p12 -k build.keychain -P "$MAC_CERT_PASS" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$MAC_KEYCHAIN_PASS" build.keychain
          codesign --options runtime --timestamp --force --sign "$MAC_CODESIGN_ID" build/chapterforge_cli

      - name: Notarize (macOS)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PWD: ${{ secrets.APPLE_APP_SPECIFIC_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        shell: bash
        run: |
          if [[ -z "$APPLE_ID" ]]; then
            echo "No notarization credentials; skipping notarization."
            exit 0
          fi
          xcrun notarytool submit build/chapterforge_cli \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PWD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple build/chapterforge_cli
