name: Update packaging (Homebrew + vcpkg)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to package (e.g., v0.10)"
        required: true
  release:
    types: [published]

jobs:
  update-packaging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Always base packaging changes on the default branch (main), not the tag name.
          ref: main

      - name: Determine tag
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Using tag: ${TAG}"

      - name: Download source archive (for vcpkg SHA512)
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          SRC_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          curl -L "${SRC_URL}" -o /tmp/src.tar.gz
          sha512sum /tmp/src.tar.gz

      - name: Compute SHA512 for vcpkg
        id: sha512
        run: |
          SHA=$(sha512sum /tmp/src.tar.gz | awk '{print $1}')
          echo "sha512=${SHA}" >> "$GITHUB_OUTPUT"
          echo "Computed SHA512: ${SHA}"

      - name: Download macOS universal package (for Homebrew SHA256)
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          PKG_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/chapterforge-${TAG}-macos-latest-universal.zip"
          curl -L "${PKG_URL}" -o /tmp/chapterforge-macos.zip
          sha256sum /tmp/chapterforge-macos.zip

      - name: Compute SHA256 for Homebrew
        id: sha256
        run: |
          SHA=$(sha256sum /tmp/chapterforge-macos.zip | awk '{print $1}')
          echo "sha256=${SHA}" >> "$GITHUB_OUTPUT"
          echo "Computed SHA256: ${SHA}"

      - name: Update vcpkg overlay
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          SHA="${{ steps.sha512.outputs.sha512 }}"
          sed -i "s|REF \".*\"|REF \"${TAG}\"|g" ports/chapterforge/portfile.cmake
          sed -i "s|SHA512 \".*\"|SHA512 \"${SHA}\"|g" ports/chapterforge/portfile.cmake

      - name: Update Homebrew formula
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          SHA="${{ steps.sha256.outputs.sha256 }}"
          PKG_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/chapterforge-${TAG}-macos-latest-universal.zip"
          sed -i "s|url \"https://github.com/.*/releases/download/.*/.*\"|url \"${PKG_URL}\"|g" Formula/chapterforge.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA}\"|g" Formula/chapterforge.rb
          sed -i "s|version \".*\"|version \"${TAG}\"|g" Formula/chapterforge.rb || true

      - name: Create packaging PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update packaging for ${{ steps.vars.outputs.tag }}"
          title: "Update packaging for ${{ steps.vars.outputs.tag }}"
          body: |
            - Update Homebrew formula URL/SHA to ${{ steps.vars.outputs.tag }}
            - Update vcpkg overlay REF/SHA512 to ${{ steps.vars.outputs.tag }}
          branch: "bot/update-packaging-${{ steps.vars.outputs.tag }}"
          base: main
