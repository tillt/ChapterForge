<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChapterForge: ChapterForge</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ChapterForge
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ChapterForge </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2_users_2till_2_development_2chapterforge_2chapterforge_2_r_e_a_d_m_e"></a></p>
<p>[<img src="https://img.shields.io/badge/license-MIT-green.svg" alt="License: MIT" style="pointer-events: none;" class="inline"/>](LICENSE) ![Build](https://img.shields.io/badge/build-CMake-blue.svg) ![Tests](https://img.shields.io/badge/tests-ctest-orange.svg)</p>
<p>ChapterForge is a library and CLI to mux chapters (text and optional images) into AAC/M4A files while preserving metadata and handling Apple-compatible chapter tracks.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1"></a>
Motivation and Backstory</h1>
<p>MPEG4 and its container MP4 standard do not explicitly describe chapter marks. Apple however did, implicitly.</p>
<p>Back in the days, under the umbrella of the QuickTime.framework, Apple had released authoring tools for audiobooks. With those tools you could add jump-marks to an M4A file. Those jump-marks could have a description text, an image and possibly more. That way a user could conveniently jump to specific sections of the audio &ndash; useful for example as a mark for chapters. There are many players that understand those, but not all do. Specifically Apple who has pushed for this "extension" of the standard, has traditionally been understanding it in their players. That is true for Music.app, iTunes.app, QuickTime.app and even Books.app. All of them today support chapter marks. Windows has existing support there as well. That said it becomes clear, this is not standard but at least a functional solution for the challenge of encoding such thing into the audio file.</p>
<p>Apple did support authoring tools - but that was way back in PowerPC times. The QTKit is long gone. There appears to be not a single open source tool in the market that would support a recent OS. There are tools like ffmpeg - it does even support chapter marks for MP4 - but - no images for those. The only tool in the market supporting images in chapter marks in 2025 appears to be Auphonic - commercial.</p>
<p>All the existing libraries offered to application developers, even the commercial ones like Bento4 do not support chapter marks with images. AVFoundation, the framework Apple offers these days for media playback and authoring does fully support reading of MP4 chapter marks including images. Thus creating a player supporting that feature is trivial. The kicker here is, Apple does not support any way of authoring / writing / creating such files - none at all.</p>
<p>No one had a strong enough interest to change this, until today.</p>
<p>The player I am tinkering with needs support for storing a track-list / set-list in the file itself. That way I can attribute those beautiful DJ sets and have neat track-mark thumbnails and descriptions on the player, persisted in the M4A file. A few thousand lines of code later, we have a new library based on no other works available which does the job for me - maybe also for you.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Features</h1>
<p>ChapterForge uses the audio track from the input. It then combines that with a text track for the description, an optional text track for per-chapter URLs, and a video track for optional chapter images. All of that information gets bundled in the resulting output M4A file. With that M4A file you can now see chapter marks in your player.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md3"></a>
Notes on Apple-style chapter URL handling</h2>
<ul>
<li>A second <span class="tt">tx3g</span> track is created only when at least one chapter provides a <span class="tt">url</span>. Its samples carry an <span class="tt">href</span> modifier box; AVFoundation surfaces this as <span class="tt">extraAttributes[HREF]</span>.</li>
<li>URL samples may have empty text; the <span class="tt">href</span> drives the URL display.</li>
<li>Text tracks are padded with two extra samples (like the golden files) to satisfy Apple players: sample_count = chapter_count + 2, stts/stsz/stsc entries match that.</li>
<li>Images remain separate (MJPEG track) and are unaffected by the URL/text pairing.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md4"></a>
Platforms</h1>
<p>Supported players (just a selection of known goods):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"></th><th class="markdownTableHeadCenter">text  </th><th class="markdownTableHeadCenter">image  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">QuickTime.app  </td><td class="markdownTableBodyCenter">X  </td><td class="markdownTableBodyCenter">X  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Music.app  </td><td class="markdownTableBodyCenter">X  </td><td class="markdownTableBodyCenter">X  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Books.app  </td><td class="markdownTableBodyCenter">X  </td><td class="markdownTableBodyCenter">X  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">VLC  </td><td class="markdownTableBodyCenter">X  </td><td class="markdownTableBodyCenter"></td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="autotoc_md5"></a>
Building</h1>
<div class="fragment"><div class="line">cmake -S . -B build</div>
<div class="line">cmake --build build</div>
</div><!-- fragment --><p>Targets:</p><ul>
<li><span class="tt"><a class="el" href="namespacechapterforge.html">chapterforge</a></span> — static library</li>
<li><span class="tt">chapterforge_cli</span> — command-line tool</li>
</ul>
<p>Notes:</p><ul>
<li>Requires a compiler with C++20 support.</li>
<li>Fast-start is on by default.</li>
<li>Tests and docs are optional targets (see below).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
Tests</h1>
<div class="fragment"><div class="line">cmake -S . -B build -DENABLE_OUTPUT_TOOL_TESTS=ON</div>
<div class="line">cmake --build build</div>
<div class="line">cd build</div>
<div class="line">ctest --output-on-failure</div>
</div><!-- fragment --><p>Optional toggles (pass during configure):</p><ul>
<li><span class="tt">-DENABLE_BIG_IMAGE_TESTS=ON</span> — run heavy image/long-duration fixtures (requires <span class="tt">input_big.m4a</span> and large JPEGs).</li>
<li><span class="tt">-DENABLE_STRICT_VALIDATION=ON</span> — run additional tool-based checks if mp4info/mp4dump/AtomicParsley/ffprobe/MP4Box are present.</li>
<li><span class="tt">-DENABLE_AVFOUNDATION_SMOKE=ON</span> — macOS-only Swift smoke test (requires <span class="tt">swift</span>).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md7"></a>
CLI Usage</h1>
<div class="fragment"><div class="line">./chapterforge_cli &lt;input.m4a|.mp4|.aac&gt; &lt;chapters.json&gt; &lt;output.m4a&gt;</div>
<div class="line">./chapterforge_cli --version</div>
</div><!-- fragment --><ul>
<li>If the input already has metadata (<span class="tt">ilst</span>), it is reused by default.</li>
<li>Fast-start is on by default.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
Chapters JSON format</h1>
<p>ChapterForge consumes a simple JSON document:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;title&quot;: &quot;Sample Podcast Episode&quot;,     // optional top-level metadata</div>
<div class="line">  &quot;artist&quot;: &quot;John Doe&quot;,</div>
<div class="line">  &quot;album&quot;: &quot;My Podcast&quot;,</div>
<div class="line">  &quot;genre&quot;: &quot;Podcast&quot;,</div>
<div class="line">  &quot;year&quot;: &quot;2024&quot;,</div>
<div class="line">  &quot;comment&quot;: &quot;Created with ChapterForge&quot;,</div>
<div class="line">  &quot;cover&quot;: &quot;cover.jpg&quot;,                  // optional; path is relative to the JSON file</div>
<div class="line"> </div>
<div class="line">  &quot;chapters&quot;: [</div>
<div class="line">    {</div>
<div class="line">      &quot;title&quot;: &quot;Introduction&quot;,           // required</div>
<div class="line">      &quot;start_ms&quot;: 0,                     // required: chapter start time in milliseconds</div>
<div class="line">      &quot;image&quot;: &quot;chapter1.jpg&quot;,           // optional; path relative to the JSON file</div>
<div class="line">      &quot;url&quot;: &quot;https://example.com&quot;       // optional; creates a URL text track with HREF</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      &quot;title&quot;: &quot;Main Discussion&quot;,</div>
<div class="line">      &quot;start_ms&quot;: 10000,</div>
<div class="line">      &quot;image&quot;: &quot;chapter2.jpg&quot;,</div>
<div class="line">      &quot;url&quot;: &quot;&quot;</div>
<div class="line">    }</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>Notes:</p><ul>
<li>Chapters are positioned by absolute start times (<span class="tt">start_ms</span>); the muxer converts these to durations internally.</li>
<li>Chapter images are optional; omit <span class="tt">image</span> to create a text-only chapter.</li>
<li>Chapter URLs are optional; omit <span class="tt">url</span> to skip the URL track entirely.</li>
<li>If top-level metadata fields are omitted and the input file already contains an <span class="tt">ilst</span>, the existing metadata is preserved automatically.</li>
<li>Paths for <span class="tt">cover</span> and per-chapter <span class="tt">image</span> are resolved relative to the JSON file location.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
Embedding API (C++)</h1>
<p>Public header: <span class="tt"><a class="el" href="chapterforge_8hpp.html">chapterforge.hpp</a></span></p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="stbl__text__builder_8hpp.html#struct_chapter_text_sample">ChapterTextSample</a> {</div>
<div class="line">  std::string <a class="code hl_variable" href="stbl__text__builder_8hpp.html#aac96a43112fc1c3d3a07863cd8d5593d">text</a>;       <span class="comment">// UTF-8 chapter title</span></div>
<div class="line">  uint32_t <a class="code hl_variable" href="stbl__text__builder_8hpp.html#a6a5d34b4ca72520ffdd9c8aa2354b876">start_ms</a> = 0;  <span class="comment">// absolute start time in milliseconds</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="stbl__image__builder_8hpp.html#struct_chapter_image_sample">ChapterImageSample</a> {</div>
<div class="line">  std::vector&lt;uint8_t&gt; <a class="code hl_variable" href="stbl__image__builder_8hpp.html#a60dfa8cc76d2b1a132342a9296b7cb0a">data</a>; <span class="comment">// JPEG bytes for this chapter frame</span></div>
<div class="line">  uint32_t <a class="code hl_variable" href="stbl__image__builder_8hpp.html#af558b07233c248f7ece59d932826fb84">start_ms</a> = 0;     <span class="comment">// absolute start time in milliseconds</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="namespacechapterforge.html#a04cbeb074ec1f154261c5fe78e035975">mux_file_to_m4a</a>(<span class="keyword">const</span> std::string&amp; input_audio_path,</div>
<div class="line">                     <span class="keyword">const</span> std::string&amp; chapter_json_path,</div>
<div class="line">                     <span class="keyword">const</span> std::string&amp; output_path);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="namespacechapterforge.html#a04cbeb074ec1f154261c5fe78e035975">mux_file_to_m4a</a>(<span class="keyword">const</span> std::string&amp; input_audio_path,</div>
<div class="line">                     <span class="keyword">const</span> std::vector&lt;ChapterTextSample&gt;&amp; text_chapters,</div>
<div class="line">                     <span class="keyword">const</span> std::vector&lt;ChapterImageSample&gt;&amp; image_chapters,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code hl_struct" href="meta__builder_8hpp.html#struct_metadata_set">MetadataSet</a>&amp; metadata,</div>
<div class="line">                     <span class="keyword">const</span> std::string&amp; output_path);</div>
<div class="ttc" id="ameta__builder_8hpp_html_struct_metadata_set"><div class="ttname"><a href="meta__builder_8hpp.html#struct_metadata_set">MetadataSet</a></div><div class="ttdef"><b>Definition</b> meta_builder.hpp:26</div></div>
<div class="ttc" id="anamespacechapterforge_html_a04cbeb074ec1f154261c5fe78e035975"><div class="ttname"><a href="namespacechapterforge.html#a04cbeb074ec1f154261c5fe78e035975">chapterforge::mux_file_to_m4a</a></div><div class="ttdeci">bool mux_file_to_m4a(const std::string &amp;input_audio_path, const std::string &amp;chapter_json_path, const std::string &amp;output_path, bool fast_start=true)</div><div class="ttdef"><b>Definition</b> chapterforge.cpp:144</div></div>
<div class="ttc" id="astbl__image__builder_8hpp_html_a60dfa8cc76d2b1a132342a9296b7cb0a"><div class="ttname"><a href="stbl__image__builder_8hpp.html#a60dfa8cc76d2b1a132342a9296b7cb0a">ChapterImageSample::data</a></div><div class="ttdeci">std::vector&lt; uint8_t &gt; data</div><div class="ttdef"><b>Definition</b> stbl_image_builder.hpp:20</div></div>
<div class="ttc" id="astbl__image__builder_8hpp_html_af558b07233c248f7ece59d932826fb84"><div class="ttname"><a href="stbl__image__builder_8hpp.html#af558b07233c248f7ece59d932826fb84">ChapterImageSample::start_ms</a></div><div class="ttdeci">uint32_t start_ms</div><div class="ttdef"><b>Definition</b> stbl_image_builder.hpp:21</div></div>
<div class="ttc" id="astbl__image__builder_8hpp_html_struct_chapter_image_sample"><div class="ttname"><a href="stbl__image__builder_8hpp.html#struct_chapter_image_sample">ChapterImageSample</a></div><div class="ttdef"><b>Definition</b> stbl_image_builder.hpp:19</div></div>
<div class="ttc" id="astbl__text__builder_8hpp_html_a6a5d34b4ca72520ffdd9c8aa2354b876"><div class="ttname"><a href="stbl__text__builder_8hpp.html#a6a5d34b4ca72520ffdd9c8aa2354b876">ChapterTextSample::start_ms</a></div><div class="ttdeci">uint32_t start_ms</div><div class="ttdef"><b>Definition</b> stbl_text_builder.hpp:23</div></div>
<div class="ttc" id="astbl__text__builder_8hpp_html_aac96a43112fc1c3d3a07863cd8d5593d"><div class="ttname"><a href="stbl__text__builder_8hpp.html#aac96a43112fc1c3d3a07863cd8d5593d">ChapterTextSample::text</a></div><div class="ttdeci">std::string text</div><div class="ttdef"><b>Definition</b> stbl_text_builder.hpp:21</div></div>
<div class="ttc" id="astbl__text__builder_8hpp_html_struct_chapter_text_sample"><div class="ttname"><a href="stbl__text__builder_8hpp.html#struct_chapter_text_sample">ChapterTextSample</a></div><div class="ttdef"><b>Definition</b> stbl_text_builder.hpp:20</div></div>
</div><!-- fragment --><p>If <span class="tt">metadata</span> is empty and the source has an <span class="tt">ilst</span>, it is reused automatically.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Minimal C++ usage (CLI equivalent)</h1>
<p>The CLI front-end is effectively:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="chapterforge_8hpp.html">chapterforge.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  <span class="keywordflow">if</span> (argc != 4) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;usage: chapterforge &lt;input.m4a|.mp4|.aac&gt; &lt;chapters.json&gt; &lt;output.m4a&gt;\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 2;</div>
<div class="line">  }</div>
<div class="line">  std::string input   = argv[1];</div>
<div class="line">  std::string chapters= argv[2];</div>
<div class="line">  std::string output  = argv[3];</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!<a class="code hl_function" href="namespacechapterforge.html#a04cbeb074ec1f154261c5fe78e035975">chapterforge::mux_file_to_m4a</a>(input, chapters, output)) {</div>
<div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;chapterforge: failed to write output\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Wrote: &quot;</span> &lt;&lt; output &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="achapterforge_8hpp_html"><div class="ttname"><a href="chapterforge_8hpp.html">chapterforge.hpp</a></div></div>
<div class="ttc" id="amain_8cpp_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="main_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition</b> main.cpp:16</div></div>
</div><!-- fragment --><p>Use the higher-level overload if you already have chapters/material in memory and don’t want to read JSON on disk.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
Atom flow (input → output)</h1>
<p>ChapterForge preserves the source audio track and metadata (<span class="tt">ilst</span>) and adds up to three new tracks for chapters:</p>
<div class="fragment"><div class="line">Input (AAC in M4A/MP4)</div>
<div class="line">├─ ftyp</div>
<div class="line">├─ free (optional)</div>
<div class="line">├─ moov</div>
<div class="line">│  ├─ mvhd</div>
<div class="line">│  ├─ trak (audio)</div>
<div class="line">│  │  ├─ tkhd</div>
<div class="line">│  │  └─ mdia → minf → stbl (reused, including stsd/stts/stsc/stsz/stco)</div>
<div class="line">│  └─ udta/meta/ilst (reused if present)</div>
<div class="line">└─ mdat</div>
<div class="line"> </div>
<div class="line">Output (ChapterForge)</div>
<div class="line">├─ ftyp</div>
<div class="line">├─ free (optional or moved for faststart)</div>
<div class="line">├─ moov</div>
<div class="line">│  ├─ mvhd</div>
<div class="line">│  ├─ trak (audio, reused stbl when input is MP4/M4A)</div>
<div class="line">│  ├─ trak (chapter titles, tx3g)</div>
<div class="line">│  │  └─ stbl with stsd(tx3g) + stts/stsc/stsz/stco (padded samples)</div>
<div class="line">│  ├─ trak (chapter URLs, tx3g with href) [only if any chapter has `url`]</div>
<div class="line">│  │  └─ same structure as titles; text may be empty, href carries the URL</div>
<div class="line">│  ├─ trak (chapter images, jpeg)</div>
<div class="line">│  │  └─ stbl with stsd(jpeg) + stts/stsc/stsz/stco/stss</div>
<div class="line">│  └─ udta/meta/ilst (reused if present, otherwise from JSON)</div>
<div class="line">└─ mdat (audio + chapter samples)</div>
</div><!-- fragment --><p>Fast-start repacks <span class="tt">moov</span> ahead of <span class="tt">mdat</span> when requested.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
Chapter track reference (titles, URLs, images)</h2>
<p><img src="docs/diagrams/chapter_tracks.png" alt="ChapterForge track layout" class="inline"/></p>
<div class="fragment"><div class="line">trak (titles)</div>
<div class="line">  tkhd flags=1, alt_group=1, id=2</div>
<div class="line">  hdlr type=&#39;text&#39;, name=&#39;Chapter Titles&#39;</div>
<div class="line">  mdia</div>
<div class="line">    mdhd timescale=1000</div>
<div class="line">    hdlr text</div>
<div class="line">    minf/nmhd</div>
<div class="line">      stbl</div>
<div class="line">        stsd -&gt; tx3g sample entry</div>
<div class="line">          displayFlags=0x00000000</div>
<div class="line">          justification=0x01ff</div>
<div class="line">          bgColor=0x1f1f1f00</div>
<div class="line">          default style: start=0 end=0 fontID=1 face=1 size=0x12 color=000000FF</div>
<div class="line">          ftab: 1 font, &quot;Sans-Serif&quot;</div>
<div class="line">        stts: one entry per sample, sample_count = chapter_count + 2 (padded)</div>
<div class="line">        stsc: 3 entries, 1 sample per chunk</div>
<div class="line">        stsz: per-sample sizes (chapter_count + 2)</div>
<div class="line">        stco: chunk offsets (chapter_count + 2)</div>
<div class="line"> </div>
<div class="line">trak (URLs, only if any chapter has `url`)</div>
<div class="line">  tkhd flags=1, alt_group=1, id=3</div>
<div class="line">  hdlr type=&#39;text&#39;, name=&#39;Chapter URLs&#39;</div>
<div class="line">  mdia/mdhd timescale=1000</div>
<div class="line">  stbl mirrors titles; samples carry `href` box:</div>
<div class="line">    sample = [len][utf8 text (often empty)][href box]</div>
<div class="line">    href box: size=0x1a, type=&#39;href&#39;, start=0, end=0x000a, url_len, url bytes, pad</div>
<div class="line">  Same padding rule: chapter_count + 2 samples, matching stts/stsc/stsz/stco</div>
<div class="line"> </div>
<div class="line">trak (images)</div>
<div class="line">  tkhd flags=7, id=4, width/height set from first JPEG</div>
<div class="line">  hdlr type=&#39;vide&#39;, name=&#39;Chapter Images&#39;</div>
<div class="line">  mdia/mdhd timescale=1000</div>
<div class="line">  stsd jpeg sample entry</div>
<div class="line">  stts/stsc/stsz/stco sized to number of images; stss marks every sample as sync</div>
</div><!-- fragment --><p>These settings mirror Apple-authored “golden” files so that QuickTime, Music.app, and AVFoundation surface titles, URLs (<span class="tt">extraAttributes[HREF]</span>), and thumbnails reliably.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
tx3g sample entry and samples (what we emit)</h2>
<ul>
<li><span class="tt">stsd</span> <span class="tt">tx3g</span> sample entry matches Apple/golden layout:<ul>
<li>displayFlags: <span class="tt">0x00000000</span></li>
<li>justification: <span class="tt">0x01FF</span></li>
<li>bg color: <span class="tt">0x1f1f1f00</span></li>
<li>default style: start=0, end=0, fontID=1, face=1, size=0x12, color RGBA <span class="tt">00 00 00 FF</span></li>
<li>font table: single entry “Sans-Serif”</li>
</ul>
</li>
<li>Text samples: <span class="tt">[len][utf8 text][href box?]</span> where href box is <span class="tt">size=0x1a type=href start=0 end=0x000a len url pad</span>.</li>
<li>Padding: we duplicate the final text/URL samples twice so Apple players see <span class="tt">chapter_count + 2</span> samples (mirrors golden behavior).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Contributing</h1>
<p>Issues and PRs are welcome. Please:</p><ul>
<li>Keep changes ASCII unless the file already uses Unicode.</li>
<li>Run tests before submitting: <span class="tt">cmake -S . -B build -DENABLE_OUTPUT_TOOL_TESTS=ON &amp;&amp; cmake --build build &amp;&amp; (cd build &amp;&amp; ctest --output-on-failure)</span>.</li>
<li>Add or update tests when you change muxing behavior, metadata handling, or JSON parsing.</li>
<li>Keep comments concise and only where the code isn’t self-explanatory.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Advanced Usage</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Objective-C++ Example</h2>
<p>Invoking <span class="tt"><a class="el" href="mp4__muxer_8hpp.html#a81a8390e29f287be1d4abd9d84fde4dd">write_mp4</a></span> from Objective-C++ using an <span class="tt">NSArray&lt;NSDictionary*&gt;</span> of chapters (<span class="tt">@"title"</span>: <span class="tt">NSString*</span>, <span class="tt">@"time"</span>: <span class="tt">NSNumber</span> in milliseconds):</p>
<div class="fragment"><div class="line"> -c++</div>
<div class="line">#import &quot;chapterforge.hpp&quot; // public header</div>
<div class="line">#import &lt;Foundation/Foundation.h&gt;</div>
<div class="line"> </div>
<div class="line">static void BuildChaptersFromDict(NSArray&lt;NSDictionary *&gt; *chapterArray,</div>
<div class="line">                                  std::vector&lt;ChapterTextSample&gt; &amp;textChapters) {</div>
<div class="line">    textChapters.clear();</div>
<div class="line">    textChapters.reserve([chapterArray count]);</div>
<div class="line">    for (NSDictionary *entry in chapterArray) {</div>
<div class="line">        NSString *title = entry[@&quot;title&quot;];</div>
<div class="line">        NSNumber *startMs = entry[@&quot;time&quot;];</div>
<div class="line">        if (!title || !startMs) continue;</div>
<div class="line">        ChapterTextSample s{};</div>
<div class="line">        s.text = [title UTF8String];</div>
<div class="line">        s.start_ms = [startMs unsignedIntValue];</div>
<div class="line">        textChapters.push_back(std::move(s));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void ExampleMuxFromObjectiveC(NSArray&lt;NSDictionary *&gt; *chaptersDict,</div>
<div class="line">                              const AacExtractResult &amp;aac,</div>
<div class="line">                              const std::string &amp;outputPath) {</div>
<div class="line">    std::vector&lt;ChapterTextSample&gt; textChapters;</div>
<div class="line">    std::vector&lt;ChapterImageSample&gt; imageChapters; // empty if no images</div>
<div class="line">    BuildChaptersFromDict(chaptersDict, textChapters);</div>
<div class="line"> </div>
<div class="line">    MetadataSet meta{}; // leave empty to reuse source ilst</div>
<div class="line">    Mp4aConfig cfg{};</div>
<div class="line">    cfg.sample_rate = aac.sample_rate;</div>
<div class="line">    cfg.channel_count = aac.channel_config;</div>
<div class="line">    cfg.sampling_index = aac.sampling_index;</div>
<div class="line">    cfg.audio_object_type = aac.audio_object_type;</div>
<div class="line"> </div>
<div class="line">    bool ok = write_mp4(outputPath, aac, textChapters, imageChapters, cfg, meta,</div>
<div class="line">                        /*fast_start=*/true, nullptr);</div>
<div class="line">    if (!ok) {</div>
<div class="line">        NSLog(@&quot;Failed to write output&quot;);</div>
<div class="line">    } else {</div>
<div class="line">        NSLog(@&quot;Wrote %@&quot;, [NSString stringWithUTF8String:outputPath.c_str()]);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>If you have parsed <span class="tt">ilst</span> metadata, pass it via the optional <span class="tt">ilst_payload</span> parameter on <span class="tt"><a class="el" href="mp4__muxer_8hpp.html#a81a8390e29f287be1d4abd9d84fde4dd">write_mp4</a></span> to force reuse. Leaving <span class="tt">meta</span> empty will reuse the source <span class="tt">ilst</span> when available.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
Disclaimer</h1>
<p>This is anything but a reference implementation. Many shortcuts were taken to reach the goal. There are plenty of hardcoded, magic bytes in this project and the parsers may explode with the next file you provide to them. If you need enterprise grade, this is not the library for you. If you need something similar but not exactly what this does, you better are a developer ready to contribute when contacting me as I have no interest in working for you. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
